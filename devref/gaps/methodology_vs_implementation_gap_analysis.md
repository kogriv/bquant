# Gap Analysis: Research Methodology vs. Code Implementation

This document provides a detailed comparison between the goals outlined in `research/methodology/macd_research.md` and the actual implementation within the `bquant` package.

The analysis highlights a key architectural issue: **two parallel, non-synchronized implementations** of the analysis logic.
- **`MACDZoneAnalyzer`**: A self-contained class in `bquant/indicators/macd.py` that appears to be an older, more direct implementation of the research.
- **`bquant.analysis` package**: A newer, more modular but less complete implementation (`ZoneFeaturesAnalyzer`, `HypothesisTestSuite`, etc.).

## Comparison Table

| Требование из методологии (Requirement from Methodology) | Реализация в `MACDZoneAnalyzer` (`macd.py`) | Реализация в пакете (`bquant.analysis.*`) | Статус и комментарии |
| :--- | :--- | :--- | :--- |
| **1. Сегментация зон (Zone Segmentation)** | | | |
| Определение зон по знаку MACD | ✔️ **Реализовано** (`identify_zones`) | ✔️ **Реализовано** (Предполагается, что зоны передаются в анализаторы) | **OK** |
| Учет мин. длительности зоны | ✔️ **Реализовано** (параметр `min_duration`) | ✔️ **Реализовано** (параметр в `ZoneFeaturesAnalyzer`) | **OK** |
| Нормализация по ATR | ✔️ **Реализовано** (`calculate_macd_with_atr`, `price_return_atr`) | ◐ **Частично** (`atr` используется, если передан в `ZoneFeatures`) | **OK**. `MACDZoneAnalyzer` является основным исполнителем. |
| **2. Инжиниринг признаков (Feature Engineering)** | | | |
| Длительность, доходность, амплитуда | ✔️ **Реализовано** | ✔️ **Реализовано** | **OK** |
| Просадка/отскок от пика/дна | ✔️ **Реализовано** (`drawdown_from_peak`, `rally_from_trough`) | ✔️ **Реализовано** | **OK** |
| Корреляция цены и гистограммы | ✔️ **Реализовано** (`price_hist_corr`) | ✔️ **Реализовано** | **OK** |
| Кол-во пиков/впадин (свинги) | ✔️ **Реализовано** (`num_peaks`, `num_troughs`) | ✔️ **Реализовано** | **OK** |
| Метрики времени (Time-to-peak ratio) | ✔️ **Реализовано** (`peak_time_ratio`, `trough_time_ratio`) | ❌ **Отсутствует** | **Пробел/Несоответствие**. Реализовано только в `MACDZoneAnalyzer`. |
| Продвинутый анализ свингов | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. Нет расчета среднего размера ралли/откатов. |
| Метрики дивергенций | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| Метрики объема | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| Метрики формы (Skew, Kurtosis) | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **3. Статистический анализ (Statistical Analysis)** | | | |
| Описательные статистики | ✔️ **Реализовано** (`analyze_zones_distribution`) | ✔️ **Реализовано** (`analyze_zones_distribution`) | **Дублирование**. Обе реализации существуют. |
| Тест на стационарность (ADF) | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **4. Проверка гипотез (Hypothesis Testing)** | | | |
| H1: Длина зоны vs. разворот | ✔️ **Реализовано** | ✔️ **Реализовано** (`test_zone_duration_hypothesis`) | **Дублирование**. |
| H2: Наклон гистограммы vs. длина | ❌ **Отсутствует** | ◐ **Частично** (Тест есть, но требует `hist_slope`, который не рассчитывается) | **Пробел**. Неработоспособный тест в пакете. |
| H4: Корреляция vs. просадка | ✔️ **Реализовано** | ❌ **Отсутствует** | **Пробел/Несоответствие**. Реализовано только в `MACDZoneAnalyzer`. |
| H5: Уровни поддержки/сопротивления | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **5. Моделирование (Modeling)** | | | |
| Кластеризация (K-Means) | ✔️ **Реализовано** (`cluster_zones_by_shape`) | ✔️ **Реализовано** (`cluster_zones`) | **Дублирование**. Обе реализации существуют. |
| Цепи Маркова | ◐ **Частично** (Только переходы `bull`/`bear`) | ✔️ **Реализовано** (Более полная версия с расчетом стац. распределения) | **Частичная реализация**. Продвинутая версия в пакете, но обе не используют сложные состояния. |
| Регрессия (OLS) | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **6. Валидация (Validation)** | | | |
| Out-of-Sample / Walk-Forward | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. Нет встроенных инструментов. |
| Анализ чувствительности | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |

## Выводы

1.  **Фундамент заложен:** Основные механизмы для анализа зон реализованы.
2.  **Архитектурный долг:** Существование двух параллельных систем анализа (`MACDZoneAnalyzer` и `bquant.analysis`) является серьезной проблемой, которую нужно решать. Это приводит к несоответствиям и усложняет поддержку.
3.  **Значительные пробелы:** Наиболее продвинутые части методологии (детали свингов, дивергенции, объем, регрессия, ADF-тесты, валидация) не реализованы.
4.  **Несоответствие реализаций:** Некоторые функции реализованы только в одном из двух мест, что делает модульный подход `bquant.analysis` неполным.

**Рекомендация:** Первоочередной задачей должна стать **консолидация логики**. Необходимо выбрать единый источник правды (предпочтительно, модульный пакет `bquant.analysis`) и перенести в него всю функциональность из `MACDZoneAnalyzer`, устранив пробелы.
