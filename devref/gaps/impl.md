# Анализ реализации методологии исследования в пакете BQuant

## Введение

Настоящий документ представляет собой анализ пакета `bquant` с целью определения, насколько полно в нем реализованы задачи, описанные в методологии исследования (`research/methodology/README.md`). Анализ охватывает основные функциональные блоки пакета: технические индикаторы, статистические методы, зональный анализ и машинное обучение.

## Общий вывод

Пакет `bquant` в значительной степени реализует большинство концепций, изложенных в методологии. Присутствуют модули для расчета всех ключевых индикаторов, проведения статистических тестов, анализа зон и применения методов машинного обучения.

**Ключевая проблема** заключается в наличии двух параллельных, частично дублирующих друг друга реализаций:
1.  **Модульная архитектура:** Набор узкоспециализированных, мощных и хорошо структурированных анализаторов в директории `bquant/analysis/`.
2.  **Монолитная архитектура:** Крупный класс `MACDZoneAnalyzer` в `bquant/indicators/macd.py`, который объединяет в себе множество функций, но реализует их проще и менее гибко.

Это дублирование ведет к избыточности кода, потенциальным несоответствиям и усложняет дальнейшую поддержку и развитие пакета. `MACDZoneAnalyzer`, по-видимому, является наследием более раннего, скриптового подхода к анализу.

---

## Детальный анализ по разделам методологии

### 1. Технический анализ

**Требования методологии:**
- MACD, SMA, EMA, RSI, Bollinger Bands.
- Кастомные индикаторы.

**Реализация в `bquant`:**
- **Полнота:** **Высокая.**
- **Расположение:** `bquant/indicators/library.py`
- **Описание:** Все перечисленные индикаторы реализованы в виде классов, унаследованных от `PreloadedIndicator`. Архитектура `IndicatorFactory` (в `bquant/indicators/base.py`) позволяет легко регистрировать и использовать как встроенные, так и кастомные индикаторы.
- **Соответствие:** Реализация полностью соответствует требованиям методологии.

### 2. Статистические методы

**Требования методологии:**
- Проверка гипотез (t-тесты, корреляции, Chi-square, Runs test).
- Анализ распределений (нормальность, skewness, kurtosis, effect size).
- Коррекция на множественные сравнения.

**Реализация в `bquant`:**
- **Полнота:** **Высокая (но фрагментированная).**
- **Расположение:**
    - `bquant/analysis/statistical/hypothesis_testing.py` (мощная, неиспользуемая реализация).
    - `bquant/indicators/macd.py` (упрощенная, используемая реализация).
    - `bquant/analysis/zones/zone_features.py` (анализ распределений).
- **Описание:**
    - `HypothesisTestSuite` — это полноценный модуль для статистических тестов. Он включает расчет p-value, размера эффекта (Cohen's d), доверительных интервалов и коррекцию на множественные сравнения (Holm-Bonferroni). **Этот модуль не используется `MACDZoneAnalyzer`.**
    - `MACDZoneAnalyzer` имеет собственный метод `test_hypotheses`, который реализует только базовые t-тесты и корреляцию Пирсона без дополнительных метрик.
    - `ZoneFeaturesAnalyzer` предоставляет детальный анализ распределений, включая асимметрию и эксцесс, что соответствует методологии.
- **Соответствие:** Функциональность присутствует, но ее использование в основном пакете неоптимально из-за дублирования и использования упрощенных версий.

### 3. Зональный анализ

**Требования методологии:**
- Методология выделения зон.
- Анализ характеристик зон (длительность, доходность, корреляции).

**Реализация в `bquant`:**
- **Полнота:** **Высокая (но фрагментированная).**
- **Расположение:**
    - `bquant/analysis/zones/zone_features.py` (модульная реализация).
    - `bquant/indicators/macd.py` (монолитная реализация).
- **Описание:**
    - `MACDZoneAnalyzer` содержит методы `identify_zones` и `calculate_zone_features` для идентификации зон и расчета их характеристик.
    - `ZoneFeaturesAnalyzer` предлагает более структурированный подход с использованием дата-класса `ZoneFeatures` и более глубоким анализом.
    - Обе реализации покрывают требования методологии, но делают это параллельно.
- **Соответствие:** Высокое, но страдает от дублирования кода.

### 4. Машинное обучение

**Требования методологии:**
- Кластеризация (K-means, метрики качества).
- Анализ последовательностей (Марковские цепи, анализ переходов).

**Реализация в `bquant`:**
- **Полнота:** **Высокая (но фрагментированная).**
- **Расположение:**
    - `bquant/analysis/zones/sequence_analysis.py` (мощная реализация).
    - `bquant/indicators/macd.py` (упрощенная реализация).
    - `bquant/ml/` (пусто).
- **Описание:**
    - `ZoneSequenceAnalyzer` — это мощный модуль, который включает:
        - Кластеризацию K-Means с нормализацией данных, оценкой качества (Silhouette score) и анализом важности признаков.
        - Глубокий анализ последовательностей, включая **цепи Маркова**, поиск паттернов и тесты на случайность.
    - `MACDZoneAnalyzer` также реализует кластеризацию и анализ последовательностей, но на базовом уровне, без продвинутых метрик и методов, описанных в `ZoneSequenceAnalyzer`.
- **Соответствие:** Функциональность, описанная в методологии, полностью реализована в `ZoneSequenceAnalyzer`, но `MACDZoneAnalyzer` использует свою упрощенную версию.

---

## Рекомендации

Для устранения дублирования и улучшения архитектуры пакета `bquant` рекомендуется провести рефакторинг:

1.  **Централизовать логику:** Модифицировать класс `MACDZoneAnalyzer` так, чтобы он не реализовывал логику анализа самостоятельно, а вместо этого использовал специализированные анализаторы из `bquant/analysis/`:
    - Для расчета признаков зон — `ZoneFeaturesAnalyzer`.
    - Для тестирования гипотез — `HypothesisTestSuite`.
    - Для анализа последовательностей и кластеризации — `ZoneSequenceAnalyzer`.

2.  **Сделать `MACDZoneAnalyzer` оркестратором:** `MACDZoneAnalyzer` должен стать классом-оркестратором, который вызывает необходимые модули в правильном порядке, но не содержит сложной бизнес-логики. Его основная задача — управление процессом анализа от начала до конца.

3.  **Удалить избыточный код:** После рефакторинга следует удалить дублирующие методы из `MACDZoneAnalyzer` (`calculate_zone_features`, `test_hypotheses`, `analyze_zone_sequences`, `cluster_zones_by_shape`), оставив только вызовы к соответствующим модулям.

Эти изменения позволят создать более поддерживаемую, модульную и расширяемую архитектуру, полностью соответствующую как духу, так и букве изложенной методологии исследования.


### 1. Анализ архитектуры пакета `bquant`

Архитектура пакета `bquant` реализована на высоком качественном уровне, с соблюдением современных принципов проектирования ПО.

**Сильные стороны:**

1.  **Четкая модульность и разделение ответственности (Separation of Concerns):**
    *   Проект имеет логичную структуру каталогов, где каждый компонент имеет свое место:
        *   `bquant/core`: Ядро системы (конфигурация, логирование, исключения, утилиты). Это централизует общую функциональность и избегает дублирования кода.
        *   `bquant/indicators`: Все, что связано с техническими индикаторами. Есть четкое разделение на базовые классы (`base.py`), загрузчики из внешних библиотек (`loaders.py`), конкретные реализации (`library.py`, `macd.py`) и высокоуровневые калькуляторы (`calculators.py`).
        *   `bquant/analysis`: Модули для различных видов анализа (`zones`, `statistical` и т.д.). Каждый вид анализа вынесен в свой подпакет.
        *   `bquant/visualization`: Логика для построения графиков отделена от логики расчетов.
        *   `tests/`: Наличие отдельных каталогов для `unit` и `integration` тестов является стандартом хорошей практики.

2.  **Расширяемость и гибкость:**
    *   **Базовые классы:** Использование абстрактных базовых классов, таких как `BaseIndicator` и `BaseAnalyzer`, позволяет легко добавлять новые индикаторы и методы анализа, сохраняя единый интерфейс.
    *   **Фабрика индикаторов (`IndicatorFactory`):** Применение паттерна "Фабрика" для создания индикаторов позволяет системе динамически работать с индикаторами из разных источников (встроенными, из библиотек, пользовательскими), что делает архитектуру очень гибкой.
    *   **Загрузчики библиотек (`loaders.py`):** Система спроектирована для интеграции с популярными библиотеками, такими как `pandas-ta` и `TA-Lib`, что избавляет от необходимости "изобретать велосипед".

3.  **Продуманная конфигурация и обработка ошибок:**
    *   **Централизованная конфигурация (`core/config.py`):** Все ключевые параметры (пути, параметры индикаторов, таймфреймы) вынесены в один файл, что упрощает настройку и поддержку.
    *   **Система логирования (`core/logging_config.py`):** Наличие централизованной и настраиваемой системы логирования — признак профессионального подхода к разработке.
    *   **Пользовательские исключения (`core/exceptions.py`):** Создание собственной иерархии исключений (например, `DataError`, `AnalysisError`) делает обработку ошибок более предсказуемой и информативной.

4.  **Ориентация на производительность:**
    *   В `core/performance.py` и `core/cache.py` заложены механизмы для мониторинга производительности, кэширования в памяти и на диске, а также использования оптимизированных `NumPy` функций. Это говорит о том, что архитектура рассчитана на работу с большими объемами данных.

**Области для развития (что соответствует статусу "в разработке"):**

*   **Множество "заглушек" (Stubs):** Многие модули анализа (`candlestick`, `chart`, `technical`, `timeseries`) на данный момент являются заглушками. Это не недостаток архитектуры, а скорее показатель текущего этапа разработки. Фундамент для их реализации уже заложен.
*   **ML-модуль:** Пакет `bquant/ml` также является заглушкой, что логично, так как машинное обучение — это следующий шаг после построения базового аналитического инструментария.

**Вывод по архитектуре:** Архитектура `bquant` является зрелой, масштабируемой и хорошо продуманной. Она закладывает прочную основу для создания мощного и гибкого инструмента для количественных исследований.

---

### 2. Анализ реализации методологии `research/methodology/macd_research.md`

Пакет `bquant` в значительной степени реализует цели и задачи, изложенные в методологии анализа MACD. Видно, что документ `macd_research.md` служил прямым руководством для разработки модулей `analysis.zones`, `analysis.statistical` и `indicators.macd`.

**Соответствие ключевым пунктам методологии:**

1.  **Сегментация на "зоны":**
    *   **Реализация:** Полностью реализовано в классе `MACDZoneAnalyzer` (файл `bquant/indicators/macd.py`), метод `identify_zones`. Логика точно соответствует описанию: зоны определяются по смене знака линии MACD, есть фильтрация по минимальной длительности.

2.  **Извлечение признаков (Feature Engineering):**
    *   **Реализация:** Очень полно реализовано.
        *   Класс `ZoneFeatures` в `bquant/analysis/zones/zone_features.py` и метод `calculate_zone_features` в `MACDZoneAnalyzer` рассчитывают большинство метрик, описанных в методологии:
            *   Длительность, амплитуда MACD и гистограммы.
            *   Движение цены: `price_return`, `drawdown_from_peak`, `rally_from_trough`.
            *   Метрики согласованности: `price_hist_corr` (корреляция цены и гистограммы).
            *   Анализ экстремумов: `num_peaks`, `num_troughs`.
        *   Нормализация с помощью `ATR` также учтена (например, признак `price_return_atr`).

3.  **Статистический анализ распределений:**
    *   **Реализация:** Присутствует.
        *   Метод `analyze_zones_distribution` в `MACDZoneAnalyzer` и `ZoneFeaturesAnalyzer` выполняет описательный анализ, сравнивая характеристики бычьих и медвежьих зон, что напрямую соответствует задачам из методологии.
        *   Модуль `bquant/analysis/statistical` предоставляет общие инструменты для более глубокого анализа.

4.  **Проверка гипотез:**
    *   **Реализация:** Прямая и полная.
        *   Модуль `bquant/analysis/statistical/hypothesis_testing.py` содержит класс `HypothesisTestSuite`, который реализует проверку гипотез, описанных в документе:
            *   `test_zone_duration_hypothesis` (влияние длительности на движение цены).
            *   `test_histogram_slope_hypothesis` (корреляция наклона гистограммы и длительности).
            *   `test_bull_bear_asymmetry_hypothesis` (асимметрия бычьих и медвежьих зон).
            *   `test_sequence_hypothesis` (анализ случайности последовательностей).
            *   `test_volatility_hypothesis` (влияние волатильности).

5.  **Анализ последовательностей и форм (Паттерн-анализ):**
    *   **Реализация:** Частично реализовано и хорошо структурировано.
        *   **Анализ последовательностей:** Модуль `bquant/analysis/zones/sequence_analysis.py` содержит `ZoneSequenceAnalyzer`, который анализирует переходы между зонами и даже включает базовый анализ цепей Маркова (`_markov_chain_analysis`), что соответствует методологии.
        *   **Классификация форм:** Метод `cluster_zones_by_shape` в `MACDZoneAnalyzer` реализует идею кластеризации зон с помощью K-Means на основе их признаков.

6.  **Валидация и робастность:**
    *   **Реализация:** Этот аспект в меньшей степени отражен в коде *библиотеки*, что логично. Функции для Walk-Forward валидации или анализа чувствительности обычно являются частью *исследовательских скриптов*, а не самого пакета. Пакет предоставляет инструменты, а валидация — это процесс их использования.

**Вывод по реализации методологии:**
Задачи, поставленные в `macd_research.md`, реализованы в `bquant` на очень высоком уровне. Код не просто выполняет расчеты, а следует структуре и логике исследования, описанной в документе. Это отличный пример того, как методология исследования транслируется в качественный, переиспользуемый код.

---
# Анализ и сравнение пакета bquant с целями исследования MACD

Документ сравнивает реализацию пакета **bquant** с целями, изложенными в [research/methodology/macd_research.md](../../research/methodology/macd_research.md).

## Общее заключение

Пакет **bquant** представляет собой значительную, но неполную реализацию амбициозного плана исследований. Основные механизмы для анализа зон MACD созданы, но многие из более продвинутых и тонких метрик и методов анализа отсутствуют.

> **Ключевая архитектурная проблема:**
> - Дублирование кода: логика анализа частично реализована в виде модульной структуры в `bquant/analysis/`, а частично — в виде монолитного класса `MACDZoneAnalyzer` в `bquant/indicators/macd.py`. Эти реализации не полностью согласованы, что создает путаницу.

---

## Детальное сравнение по задачам исследования

### 1. Сегментация и базовый анализ (✔ Полностью реализовано)

- **Разбиение на зоны:** Механизм определения бычьих/медвежьих зон на основе знака MACD реализован в `MACDZoneAnalyzer.identify_zones`.
- **Обработка пограничных случаев:** Учитывается минимальная длительность зоны (`min_duration`).
- **Нормализация по ATR:** Реализован расчет ATR и его использование для нормализации признаков (например, `price_return_atr`).

### 2. Инжиниринг признаков (Feature Engineering) (◐ Частично реализовано)

**Реализовано:**
- Базовые метрики: `duration`, `price_return`, `macd_amplitude`.
- Уточненные метрики: `drawdown_from_peak`, `rally_from_trough`.
- Метрики согласованности: `correlation_price_hist`.
- Анализ свингов (базовый): подсчет количества пиков и впадин (`num_peaks`, `num_troughs`).
- Метрики времени (частично): в `macd.py` есть расчет `peak_time_ratio`, но его нет в модуле `zone_features.py`.

**Отсутствует:**
- Продвинутый анализ свингов: средний/максимальный размер импульсов и коррекций, их соотношение.
- Метрики дивергенций: расчет типа и силы дивергенций.
- Метрики объема: пакет на данный момент не использует данные по объему.
- Продвинутые метрики формы: `skewness` и `kurtosis` для гистограммы MACD.

### 3. Статистический анализ и проверка гипотез (◐ Частично реализовано)

**Реализовано:**
- Описательные статистики: анализ распределений (среднее, медиана, std) для основных признаков реализован в `ZoneFeaturesAnalyzer`.
- Проверка гипотез: реализованы тесты для нескольких ключевых гипотез:
	- Влияние длительности зоны на доходность (H1).
	- Асимметрия между бычьими и медвежьими зонами.
	- Случайность последовательностей зон.
	- Влияние корреляции на просадку (H4, но реализовано только в `macd.py`, а не в модуле `hypothesis_testing.py`).

**Отсутствует:**
- Тест на стационарность (ADF): не реализован.
- Гипотеза о наклоне гистограммы (H2): тест есть, но он неработоспособен, так как отсутствует необходимый признак `hist_slope`.
- Гипотеза об уровнях поддержки/сопротивления (H5): не реализована.

### 4. Моделирование и паттерн-анализ (◐ Частично реализовано)

**Реализовано:**
- Цепи Маркова: базовый механизм реализован в `sequence_analysis.py`, но только для простых состояний "bull"/"bear".
- Кластеризация: реализована с помощью K-Means для группировки зон по признакам.
- Анализ последовательностей: реализован поиск N-грам (триплетов) и анализ серий.

**Отсутствует:**
- Регрессионное моделирование (OLS): не реализовано.
- Продвинутая кластеризация: кластеризация не использует продвинутые признаки формы (`skewness`, `kurtosis`), так как они не рассчитываются.
- Продвинутые состояния для цепей Маркова: модель не использует состояния вроде "длинная бычья зона", "короткая медвежья зона".

### 5. Валидация и робастность (❌ Не реализовано)

- В пакете отсутствуют встроенные инструменты для проведения Out-of-Sample, Walk-Forward валидации или анализа чувствительности к параметрам. Эти процессы предполагается выполнять вручную, используя библиотеку как инструмент.

---


# Gap Analysis: Research Methodology vs. Code Implementation

This document provides a detailed comparison between the goals outlined in `research/methodology/macd_research.md` and the actual implementation within the `bquant` package.

The analysis highlights a key architectural issue: **two parallel, non-synchronized implementations** of the analysis logic.
- **`MACDZoneAnalyzer`**: A self-contained class in `bquant/indicators/macd.py` that appears to be an older, more direct implementation of the research.
- **`bquant.analysis` package**: A newer, more modular but less complete implementation (`ZoneFeaturesAnalyzer`, `HypothesisTestSuite`, etc.).

## Comparison Table

| Требование из методологии (Requirement from Methodology) | Реализация в `MACDZoneAnalyzer` (`macd.py`) | Реализация в пакете (`bquant.analysis.*`) | Статус и комментарии |
| :--- | :--- | :--- | :--- |
| **1. Сегментация зон (Zone Segmentation)** | | | |
| Определение зон по знаку MACD | ✔️ `identify_zones()` | ✔️ (Предполагается, что зоны передаются в анализаторы) | **OK** |
| Учет мин. длительности зоны | ✔️ `__init__` (параметр `zone_params['min_duration']`) | ✔️ `ZoneFeaturesAnalyzer.__init__` (параметр `min_duration`) | **OK** |
| Нормализация по ATR | ✔️ `calculate_macd_with_atr()`, `calculate_zone_features()` | ◐ `ZoneFeaturesAnalyzer.extract_zone_features()` (использует `atr`, если колонка уже есть) | **OK**. `MACDZoneAnalyzer` является основным исполнителем. |
| **2. Инжиниринг признаков (Feature Engineering)** | | | |
| Длительность, доходность, амплитуда | ✔️ `calculate_zone_features()` | ✔️ `ZoneFeaturesAnalyzer.extract_zone_features()` | **Дублирование**. |
| Просадка/отскок от пика/дна | ✔️ `calculate_zone_features()` | ✔️ `ZoneFeaturesAnalyzer.extract_zone_features()` | **Дублирование**. |
| Корреляция цены и гистограммы | ✔️ `calculate_zone_features()` | ✔️ `ZoneFeaturesAnalyzer.extract_zone_features()` | **Дублирование**. |
| Кол-во пиков/впадин (свинги) | ✔️ `calculate_zone_features()` (используя `scipy.signal.find_peaks`) | ✔️ `ZoneFeaturesAnalyzer.extract_zone_features()` (используя `scipy.signal.find_peaks`) | **Дублирование**. |
| Метрики времени (Time-to-peak ratio) | ✔️ `calculate_zone_features()` (рассчитывает `peak_time_ratio`, `trough_time_ratio`) | ❌ **Отсутствует** | **Пробел/Несоответствие**. Реализовано только в `MACDZoneAnalyzer`. |
| Продвинутый анализ свингов | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. Нет расчета среднего размера ралли/откатов. |
| Метрики дивергенций | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| Метрики объема | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| Метрики формы (Skew, Kurtosis) | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **3. Статистический анализ (Statistical Analysis)** | | | |
| Описательные статистики | ✔️ `analyze_zones_distribution()` | ✔️ `ZoneFeaturesAnalyzer.analyze_zones_distribution()` | **Дублирование**. Обе реализации существуют. |
| Тест на стационарность (ADF) | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **4. Проверка гипотез (Hypothesis Testing)** | | | |
| H1: Длина зоны vs. разворот | ✔️ `test_hypotheses()` | ✔️ `HypothesisTestSuite.test_zone_duration_hypothesis()` | **Дублирование**. |
| H2: Наклон гистограммы vs. длина | ❌ **Отсутствует** | ◐ `HypothesisTestSuite.test_histogram_slope_hypothesis()` (Тест есть, но требует `hist_slope`, который не рассчитывается) | **Пробел**. Неработоспособный тест в пакете. |
| H4: Корреляция vs. просадка | ✔️ `test_hypotheses()` | ❌ **Отсутствует** | **Пробел/Несоответствие**. Реализовано только в `MACDZoneAnalyzer`. |
| H5: Уровни поддержки/сопротивления | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **5. Моделирование (Modeling)** | | | |
| Кластеризация (K-Means) | ✔️ `cluster_zones_by_shape()` | ✔️ `ZoneSequenceAnalyzer.cluster_zones()` | **Дублирование**. Обе реализации существуют. |
| Цепи Маркова | ◐ `analyze_zone_sequences()` (Только переходы `bull`/`bear`) | ✔️ `ZoneSequenceAnalyzer._markov_chain_analysis()` (Более полная версия с расчетом стац. распределения) | **Частичная реализация**. Продвинутая версия в пакете, но обе не используют сложные состояния. |
| Регрессия (OLS) | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |
| **6. Валидация (Validation)** | | | |
| Out-of-Sample / Walk-Forward | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. Нет встроенных инструментов. |
| Анализ чувствительности | ❌ **Отсутствует** | ❌ **Отсутствует** | **Пробел**. |

## Выводы

1.  **Фундамент заложен:** Основные механизмы для анализа зон реализованы.
2.  **Архитектурный долг:** Существование двух параллельных систем анализа (`MACDZoneAnalyzer` и `bquant.analysis`) является серьезной проблемой, которую нужно решать. Это приводит к несоответствиям и усложняет поддержку.
3.  **Значительные пробелы:** Наиболее продвинутые части методологии (детали свингов, дивергенции, объем, регрессия, ADF-тесты, валидация) не реализованы.
4.  **Несоответствие реализаций:** Некоторые функции реализованы только в одном из двух мест, что делает модульный подход `bquant.analysis` неполным.

**Рекомендация:** Первоочередной задачей должна стать **консолидация логики**. Необходимо выбрать единый источник правды (предпочтительно, модульный пакет `bquant.analysis`) и перенести в него всю функциональность из `MACDZoneAnalyzer`, устранив пробелы.
