---
# Анализ и сравнение пакета bquant с целями исследования MACD

Документ сравнивает реализацию пакета **bquant** с целями, изложенными в [research/methodology/macd_research.md](../../research/methodology/macd_research.md).

## Общее заключение

Пакет **bquant** представляет собой значительную, но неполную реализацию амбициозного плана исследований. Основные механизмы для анализа зон MACD созданы, но многие из более продвинутых и тонких метрик и методов анализа отсутствуют.

> **Ключевая архитектурная проблема:**
> - Дублирование кода: логика анализа частично реализована в виде модульной структуры в `bquant/analysis/`, а частично — в виде монолитного класса `MACDZoneAnalyzer` в `bquant/indicators/macd.py`. Эти реализации не полностью согласованы, что создает путаницу.

---

## Детальное сравнение по задачам исследования

### 1. Сегментация и базовый анализ (✔ Полностью реализовано)

- **Разбиение на зоны:** Механизм определения бычьих/медвежьих зон на основе знака MACD реализован в `MACDZoneAnalyzer.identify_zones`.
- **Обработка пограничных случаев:** Учитывается минимальная длительность зоны (`min_duration`).
- **Нормализация по ATR:** Реализован расчет ATR и его использование для нормализации признаков (например, `price_return_atr`).

### 2. Инжиниринг признаков (Feature Engineering) (◐ Частично реализовано)

**Реализовано:**
- Базовые метрики: `duration`, `price_return`, `macd_amplitude`.
- Уточненные метрики: `drawdown_from_peak`, `rally_from_trough`.
- Метрики согласованности: `correlation_price_hist`.
- Анализ свингов (базовый): подсчет количества пиков и впадин (`num_peaks`, `num_troughs`).
- Метрики времени (частично): в `macd.py` есть расчет `peak_time_ratio`, но его нет в модуле `zone_features.py`.

**Отсутствует:**
- Продвинутый анализ свингов: средний/максимальный размер импульсов и коррекций, их соотношение.
- Метрики дивергенций: расчет типа и силы дивергенций.
- Метрики объема: пакет на данный момент не использует данные по объему.
- Продвинутые метрики формы: `skewness` и `kurtosis` для гистограммы MACD.

### 3. Статистический анализ и проверка гипотез (◐ Частично реализовано)

**Реализовано:**
- Описательные статистики: анализ распределений (среднее, медиана, std) для основных признаков реализован в `ZoneFeaturesAnalyzer`.
- Проверка гипотез: реализованы тесты для нескольких ключевых гипотез:
	- Влияние длительности зоны на доходность (H1).
	- Асимметрия между бычьими и медвежьими зонами.
	- Случайность последовательностей зон.
	- Влияние корреляции на просадку (H4, но реализовано только в `macd.py`, а не в модуле `hypothesis_testing.py`).

**Отсутствует:**
- Тест на стационарность (ADF): не реализован.
- Гипотеза о наклоне гистограммы (H2): тест есть, но он неработоспособен, так как отсутствует необходимый признак `hist_slope`.
- Гипотеза об уровнях поддержки/сопротивления (H5): не реализована.

### 4. Моделирование и паттерн-анализ (◐ Частично реализовано)

**Реализовано:**
- Цепи Маркова: базовый механизм реализован в `sequence_analysis.py`, но только для простых состояний "bull"/"bear".
- Кластеризация: реализована с помощью K-Means для группировки зон по признакам.
- Анализ последовательностей: реализован поиск N-грам (триплетов) и анализ серий.

**Отсутствует:**
- Регрессионное моделирование (OLS): не реализовано.
- Продвинутая кластеризация: кластеризация не использует продвинутые признаки формы (`skewness`, `kurtosis`), так как они не рассчитываются.
- Продвинутые состояния для цепей Маркова: модель не использует состояния вроде "длинная бычья зона", "короткая медвежья зона".

### 5. Валидация и робастность (❌ Не реализовано)

- В пакете отсутствуют встроенные инструменты для проведения Out-of-Sample, Walk-Forward валидации или анализа чувствительности к параметрам. Эти процессы предполагается выполнять вручную, используя библиотеку как инструмент.

---

## Итог

Пакет **bquant** является мощным фундаментом, который успешно автоматизирует наиболее трудоемкие части исследования MACD: сегментацию, расчет базовых признаков и основной статистический анализ. Однако для полного соответствия амбициозному плану из `macd_research.md` не хватает реализации более сложных признаков (дивергенции, объем, форма) и продвинутых методов моделирования (регрессия, ADF-тесты).

> **Наиболее срочная задача с точки зрения архитектуры:** устранение дублирования кода и создание единого, согласованного источника логики для анализа.