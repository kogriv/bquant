# Подходы к определению свингов и полнота метрик

**Дата:** 2025-10-09  
**Контекст:** Анализ правильности выбора инструментов и полноты метрик для Swing Detection

---

## 1. Оценка предложенных подходов

### ✅ ZigZag - ПОДХОДИТ (Приоритет 1)

**Суть:** Классический алгоритм определения значимых движений на основе процентного порога.

**Почему подходит:**
- Фильтрует шум, оставляя только значимые движения
- Четко определяет пики и впадины
- Настраиваемый порог значимости
- Идеально для подсчета ралли/падений и их амплитуд

**Применение:**
- Основной инструмент для определения свингов
- Используется через pandas-ta ZigZag

---

### ❌ Bollinger Bands - НЕ ПОДХОДИТ напрямую

**Суть:** Индикатор волатильности (SMA ± N × стандартных отклонений).

**Почему НЕ подходит:**
- **Это индикатор волатильности**, а не инструмент поиска экстремумов
- Пробитие полос ≠ пик/впадина
- Цена может долго идти вдоль полосы без разворота
- Ложные сигналы при трендовом движении

**Когда может быть полезен:**
- Для оценки **волатильности зоны** (отдельная метрика)
- Для фильтрации свингов по амплитуде (если свинг < width BB → незначимый)
- НЕ для прямого определения свингов

**Рекомендация:** Исключить из SwingCalculationStrategy, использовать отдельно для метрик волатильности.

---

### ❌ ATR - НЕ ПОДХОДИТ напрямую

**Суть:** Средний True Range - мера волатильности.

**Почему НЕ подходит:**
- **Это мера волатильности**, не инструмент поиска пиков/впадин
- ATR говорит "насколько сильно цена двигается", но не "где развороты"
- Не дает точек экстремумов

**Когда может быть полезен:**
- Для **нормализации амплитуд свингов** (amplitude / ATR = относительная сила)
- Для установки порога значимости в других алгоритмах
- Для оценки "тихих" vs "активных" зон
- НЕ для прямого определения свингов

**Рекомендация:** Исключить из SwingCalculationStrategy, использовать для нормализации метрик.

---

### ✅ scipy.signal.find_peaks - ПОДХОДИТ (Приоритет 2)

**Суть:** Поиск локальных максимумов/минимумов на основе математических критериев.

**Почему подходит:**
- Находит **все** локальные пики и впадины
- Настраиваемые критерии (`prominence`, `distance`, `width`)
- Векторизованный, быстрый
- УЖЕ используется в пакете

**Как использовать:**
```python
from scipy.signal import find_peaks

# Пики (высоты)
peaks_idx, _ = find_peaks(
    zone_data['high'].values, 
    prominence=threshold,  # Минимальная "выпуклость"
    distance=min_bars      # Минимум баров между пиками
)

# Впадины (низы)
troughs_idx, _ = find_peaks(
    -zone_data['low'].values, 
    prominence=threshold,
    distance=min_bars
)

# Постфильтрация: оставить только амплитуду > X%
```

**Преимущества:**
- Контроль над всеми параметрами
- Гибкость настройки под разные условия
- Может найти больше свингов, чем ZigZag

**Недостатки:**
- Может найти слишком много незначимых свингов
- Требует постфильтрации по амплитуде

**Рекомендация:** Реализовать как альтернативную стратегию `FindPeaksSwingStrategy`.

---

## 2. Дополнительные подходы (рекомендуемые)

### ✅ Pivot Points (High/Low) - ПОДХОДИТ (Приоритет 3)

**Суть:** Классический технический анализ - точки разворота на основе паттерна баров.

**Алгоритм:**
```python
# Pivot High: текущий high > N баров до и N баров после
# Pivot Low: текущий low < N баров до и N баров после

def find_pivot_highs(highs, window=2):
    pivots = []
    for i in range(window, len(highs) - window):
        if all(highs[i] > highs[i-j] for j in range(1, window+1)) and \
           all(highs[i] > highs[i+j] for j in range(1, window+1)):
            pivots.append(i)
    return pivots
```

**Параметр:** `window` (например, 2 = pivot требует 2 бара подтверждения)

**Преимущества:**
- Простой, понятный
- Естественная фильтрация шума (требует подтверждения)
- Используется многими трейдерами

**Рекомендация:** Реализовать как `PivotPointsSwingStrategy`.

---

### ✅ Fractal (Williams Fractal) - ПОДХОДИТ (Приоритет 4)

**Суть:** Паттерн из 5 баров, где средний бар - экстремум.

**Алгоритм:**
```python
# Fractal High:
# high[i] > high[i-2] and high[i] > high[i-1] and
# high[i] > high[i+1] and high[i] > high[i+2]

# Fractal Low: зеркально с low
```

**Преимущества:**
- Четкое определение (5 баров)
- Широко используется (Bill Williams)
- Хорошо работает на всех таймфреймах

**Недостатки:**
- Фиксированное окно (5 баров)
- Может пропускать более долгие свинги

**Рекомендация:** Реализовать как `FractalSwingStrategy`.

---

### ❓ Donchian Channel - ВОЗМОЖНО

**Суть:** High/Low за N периодов.

**Как использовать:**
- Прорыв нового максимума за N баров = потенциальный пик
- Прорыв нового минимума за N баров = потенциальная впадина

**Ограничения:**
- Запаздывает (нужно N баров подтверждения)
- Лучше для трендов, не для свингов внутри зоны

**Рекомендация:** Низкий приоритет, можно не реализовывать на первом этапе.

---

### ✅ Swing High/Low N-bar Pattern - ПОДХОДИТ (Приоритет 3)

**Суть:** Обобщение Pivot/Fractal с настраиваемым окном.

**Алгоритм:**
```python
def swing_high(data, left_bars=3, right_bars=3):
    """
    Swing High: high в точке i выше всех high 
    за left_bars баров слева И right_bars баров справа.
    """
    swings = []
    for i in range(left_bars, len(data) - right_bars):
        is_swing = all(
            data['high'].iloc[i] > data['high'].iloc[i-j] 
            for j in range(1, left_bars+1)
        ) and all(
            data['high'].iloc[i] > data['high'].iloc[i+j] 
            for j in range(1, right_bars+1)
        )
        if is_swing:
            swings.append(i)
    return swings
```

**Параметры:**
- `left_bars`: количество баров подтверждения слева
- `right_bars`: количество баров подтверждения справа
- Можно делать асимметричными (3/2, 5/3, etc.)

**Преимущества:**
- Гибкость
- Контроль над чувствительностью
- Естественная фильтрация шума

**Рекомендация:** Реализовать как `NBarSwingStrategy`.

---

## 3. Итоговая таблица подходов

| Подход | Подходит? | Приоритет | Тип | Примечание |
|--------|-----------|-----------|-----|------------|
| **ZigZag** | ✅ ДА | 1 | Прямой | Основной инструмент |
| **find_peaks** | ✅ ДА | 2 | Прямой | Альтернатива с гибкой настройкой |
| **Pivot Points** | ✅ ДА | 3 | Прямой | Классика ТА |
| **N-bar Swing** | ✅ ДА | 3 | Прямой | Обобщение Pivot |
| **Fractal (Williams)** | ✅ ДА | 4 | Прямой | Фиксированное окно 5 баров |
| **Bollinger Bands** | ❌ НЕТ | - | Косвенный | Только для волатильности |
| **ATR** | ❌ НЕТ | - | Косвенный | Только для нормализации |
| **Donchian** | ❓ Возможно | 5 | Косвенный | Низкий приоритет |

---

## 4. Анализ полноты метрик

### 4.1. Текущие метрики в `SwingMetrics`:

```python
@dataclass
class SwingMetrics:
    num_swings: int                # Количество свингов
    avg_rally_pct: float          # Средняя амплитуда ралли (%)
    avg_drop_pct: float           # Средняя амплитуда падения (%)
    max_rally_pct: float          # Максимальная амплитуда ралли (%)
    max_drop_pct: float           # Максимальная амплитуда падения (%)
    rally_to_drop_ratio: float    # Отношение ралли к падениям
    strategy_name: str
    strategy_params: Dict[str, Any]
```

### 4.2. Что ЕСТЬ:

✅ Количественные:
- Общее количество свингов
- Отношение ралли к падениям

✅ Амплитуды:
- Средние амплитуды (вверх/вниз)
- Максимальные амплитуды (вверх/вниз)

### 4.3. Что ОТСУТСТВУЕТ (рекомендуется добавить):

#### ❌ Метрики длительности:

```python
# ДОБАВИТЬ:
avg_rally_duration_bars: int      # Средняя длительность ралли (в барах)
avg_drop_duration_bars: int       # Средняя длительность падения (в барах)
max_rally_duration_bars: int      # Максимальная длительность ралли
max_drop_duration_bars: int       # Максимальная длительность падения
min_rally_duration_bars: int      # Минимальная длительность ралли
min_drop_duration_bars: int       # Минимальная длительность падения
```

**Зачем:** Понимать как быстро/медленно развиваются движения в зоне.

---

#### ❌ Скорость движения:

```python
# ДОБАВИТЬ:
avg_rally_speed: float            # Средняя скорость ралли (% за бар)
avg_drop_speed: float             # Средняя скорость падения (% за бар)
max_rally_speed: float            # Максимальная скорость ралли
max_drop_speed: float             # Максимальная скорость падения
```

**Расчет:** `speed = amplitude_pct / duration_bars`

**Зачем:** Различать резкие vs плавные движения.

---

#### ❌ Распределение амплитуд:

```python
# ДОБАВИТЬ:
rally_amplitude_std: float        # Стандартное отклонение амплитуд ралли
drop_amplitude_std: float         # Стандартное отклонение амплитуд падений
rally_amplitude_median: float     # Медианная амплитуда ралли
drop_amplitude_median: float      # Медианная амплитуда падения
min_rally_pct: float             # Минимальная амплитуда ралли (для порога)
min_drop_pct: float              # Минимальная амплитуда падения
```

**Зачем:** 
- Понимать консистентность свингов (высокая std = разнородные свинги)
- Медиана более устойчива к выбросам чем среднее

---

#### ❌ Счетчики направлений:

```python
# ДОБАВИТЬ:
rally_count: int                 # Количество ралли (up-движений)
drop_count: int                  # Количество падений (down-движений)
```

**Зачем:** 
- Сейчас есть `num_swings` (общее), но нет разбивки
- Важно знать сколько именно вверх vs вниз движений

---

#### ❌ Симметрия/асимметрия:

```python
# ДОБАВИТЬ:
amplitude_symmetry: float        # avg_rally / avg_drop (другая метрика чем ratio)
duration_symmetry: float         # avg_rally_duration / avg_drop_duration
speed_symmetry: float            # avg_rally_speed / avg_drop_speed
```

**Зачем:** 
- Понимать баланс сил в зоне
- Выявлять асимметричные зоны (быстрый рост + медленное падение)

---

#### ❌ Efficiency метрики:

```python
# ДОБАВИТЬ:
avg_swing_efficiency: float      # Линейное расстояние / реальный путь цены
# Efficiency = прямая линия от старта до конца свинга / сумма всех движений
# 1.0 = идеально прямой свинг, <1.0 = извилистый путь
```

**Зачем:** Понимать качество свингов (четкие vs зашумленные).

---

### 4.4. Дополнительные (опциональные):

```python
# ОПЦИОНАЛЬНО (низкий приоритет):
avg_retracement_pct: float       # Средний откат внутри свинга
max_retracement_pct: float       # Максимальный откат внутри свинга
swing_consistency_score: float   # Метрика консистентности (0-1)
```

---

## 5. ИТОГОВАЯ рекомендация по метрикам

### Обновленный `SwingMetrics`:

```python
@dataclass
class SwingMetrics:
    # === СУЩЕСТВУЮЩИЕ (оставить) ===
    num_swings: int                    # Общее количество
    avg_rally_pct: float
    avg_drop_pct: float
    max_rally_pct: float
    max_drop_pct: float
    rally_to_drop_ratio: float
    
    # === ДОБАВИТЬ: Счетчики ===
    rally_count: int                   # НОВОЕ
    drop_count: int                    # НОВОЕ
    
    # === ДОБАВИТЬ: Минимумы амплитуд ===
    min_rally_pct: float              # НОВОЕ
    min_drop_pct: float               # НОВОЕ
    
    # === ДОБАВИТЬ: Распределение амплитуд ===
    rally_amplitude_std: float         # НОВОЕ
    drop_amplitude_std: float          # НОВОЕ
    rally_amplitude_median: float      # НОВОЕ
    drop_amplitude_median: float       # НОВОЕ
    
    # === ДОБАВИТЬ: Длительность ===
    avg_rally_duration_bars: float     # НОВОЕ
    avg_drop_duration_bars: float      # НОВОЕ
    max_rally_duration_bars: int       # НОВОЕ
    max_drop_duration_bars: int        # НОВОЕ
    
    # === ДОБАВИТЬ: Скорость ===
    avg_rally_speed_pct_per_bar: float # НОВОЕ (% за бар)
    avg_drop_speed_pct_per_bar: float  # НОВОЕ
    max_rally_speed_pct_per_bar: float # НОВОЕ
    max_drop_speed_pct_per_bar: float  # НОВОЕ
    
    # === ДОБАВИТЬ: Симметрия ===
    duration_symmetry: float           # НОВОЕ (rally_dur / drop_dur)
    
    # === МЕТА ===
    strategy_name: str
    strategy_params: Dict[str, Any]
```

**Итого:** +17 новых метрик

---

## 6. План действий

### Шаг 1: Пересмотреть стратегии

**Исключить:**
- ❌ `BollingerSwingStrategy` - не для свингов
- ❌ `ATRSwingStrategy` - не для свингов

**Реализовать (в порядке приоритета):**
1. ✅ `ZigZagSwingStrategy` (pandas-ta) - **приоритет 1**
2. ✅ `FindPeaksSwingStrategy` (scipy) - **приоритет 2**
3. ✅ `PivotPointsSwingStrategy` - **приоритет 3**
4. ✅ `NBarSwingStrategy` (обобщение) - **приоритет 3**
5. ⚠️ `FractalSwingStrategy` - приоритет 4 (опционально)

---

### Шаг 2: Обновить `SwingMetrics`

**Обновить dataclass** в `bquant/analysis/zones/strategies/base.py`:
- Добавить 17 новых полей
- Обновить `validate()` метод
- Обновить `to_dict()` метод

---

### Шаг 3: Использовать Bollinger/ATR правильно

**Для волатильности зоны** (отдельные метрики, НЕ в SwingMetrics):
```python
# В ZoneFeatures или отдельной метрике:
bollinger_width_pct: float        # Ширина полос BB в % от цены
bollinger_squeeze_ratio: float    # Текущая ширина / историческая ширина
atr_normalized_zone_range: float  # Диапазон зоны / ATR
zone_volatility_score: float      # Композитная метрика волатильности
```

---

## 7. Итоговый вывод

### ✅ Правильные инструменты для свингов:
1. **ZigZag** - базовый, обязательный
2. **find_peaks** - гибкая альтернатива
3. **Pivot Points / N-bar Swing / Fractal** - классические подходы

### ❌ Неправильные инструменты:
- Bollinger Bands - для волатильности, не свингов
- ATR - для нормализации, не свингов

### 📊 Метрики: НЕПОЛНЫЕ

**Текущие:** 6 полей (только амплитуды + количество)  
**Рекомендуется:** +17 полей (длительность, скорость, распределение, счетчики)

**Критически важно добавить:**
- Длительность свингов (в барах)
- Скорость движения (% за бар)
- Счетчики rally_count / drop_count
- Минимумы и распределение амплитуд

---

## 8. Следующие действия

1. ✅ Обновить `SwingMetrics` dataclass (добавить новые поля)
2. ✅ Реализовать `ZigZagSwingStrategy` с полным расчетом метрик
3. ✅ Реализовать `FindPeaksSwingStrategy`
4. ✅ Реализовать `PivotPointsSwingStrategy` или `NBarSwingStrategy`
5. ⚠️ Исключить Bollinger/ATR из SwingStrategies
6. ⚠️ Создать отдельные метрики волатильности (VolatilityMetrics)

---

**Автор анализа:** AI Assistant  
**Дата:** 2025-10-09

