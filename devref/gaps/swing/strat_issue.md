# Исследование нулевых свинг-метрик в анализаторе зон

**Статус:** аналитический отчёт  
**Дата:** 2025-11-07

## 1. Контекст

При воспроизведении исследования устойчивости зон (`05_case_study_zone_consistency.py`) все доступные `swing`-стратегии (`find_peaks`, `pivot_points`, `zigzag`) возвращали нулевые значения по ключевым метрикам (`num_swings`, `rally_count`, `drop_count`). Это блокировало использование свинг-статистики в downstream-анализе.

## 2. Проверка исходных гипотез

### Гипотеза А: стратегии видят только индикатор, а не OHLC

Актуальный пайплайн передаёт стратегиям полный OHLC-срез зоны. `ZoneFeaturesAnalyzer` получает `zone_info['data']`, сформированный детекторами из исходного OHLCV-датафрейма, так что `open/high/low/close` доступны каждой свинг-стратегии.【F:bquant/analysis/zones/zone_features.py†L150-L199】【F:bquant/analysis/zones/detection/preloaded.py†L125-L162】

### Гипотеза B: `ZigZag` реализован через `find_peaks`

`ZigZagSwingStrategy` создаёт индикатор через `LibraryManager.create_indicator('pandas_ta', 'zigzag', ...)`, поэтому расчёт выполняется библиотекой `pandas-ta`. Параллельно существует отдельная стратегия `FindPeaksSwingStrategy`, но она не подменяет ZigZag.【F:bquant/analysis/zones/strategies/swing/zigzag.py†L21-L116】【F:bquant/analysis/zones/strategies/swing/find_peaks.py†L21-L188】

Обе гипотезы опровергнуты: корень проблемы не в отсутствии OHLC-данных и не в реализации ZigZag.

## 3. Фактическое поведение метрик

### 3.1. Диапазоны ценовых зон слишком малы для порогов по умолчанию

В sample-датасете `tv_xauusd_1h` средний прирост бычьих зон составляет ≈0.21 %, а максимальный модульный сдвиг не превышает 2.32 %.【bdd44d†L1-L29】 При этом дефолтная конфигурация запускает ZigZag с `legs=10` и `deviation=0.05` (минимум 5 % движения), а встроенные стратегии требуют амплитуд от 1.5 % до 2 %.【F:bquant/core/config.py†L150-L183】【F:bquant/analysis/zones/strategies/swing/zigzag.py†L33-L86】【F:bquant/analysis/zones/strategies/swing/find_peaks.py†L31-L145】【F:bquant/analysis/zones/strategies/swing/pivot_points.py†L21-L119】 Такие пороги отсекают практически все свинги в узких зонах.

### 3.2. Агрегированные метрики подтверждают «пустоту»

При дефолтных параметрах 37 бычьих зон не содержат ни одного свинга во `find_peaks` и `pivot_points`, а ZigZag фиксирует только 2 свинга в 2 зонах (≈0.05 свинга на зону). После тюнинга ZigZag (`legs=3`, `deviation=0.008`) метрики восстанавливаются: 23 из 37 зон содержат 55 свингов (≈1.49 на зону).【a0091f†L1-L92】

### 3.3. Кэш не учитывает конфигурацию стратегий

Ключ кэша `ZoneAnalysisPipeline` зависит от данных и настроек детекции, но не включает выбранные стратегии и их параметры. Поэтому переключение стратегии без `with_cache(enable=False)` возвращает устаревшие метрики, что маскирует эффект от тюнинга.【F:bquant/analysis/zones/pipeline.py†L235-L277】

## 4. Валидация опорных pivot-точек

Исследовательский скрипт `research/notebooks/validate_swing_pivots.py` отключает кэш, извлекает OHLC-зону, рассчитывает pivot-точки ZigZag и проверяет их монотонность/диапазон. Для зоны `id=25` (39 баров) дефолтный ZigZag находит лишь 2 pivot-а без свингов, тогда как настройки `legs=3`, `deviation=0.008` дают 8 pivot-ов и 3 пары свингов с разумными амплитудами.【F:research/notebooks/validate_swing_pivots.py†L15-L224】【4df2cd†L1-L46】 Скрипт выступает эталонным воспроизведением проблемы и демонстрацией корректной работы при ослабленных порогах.

## 5. Выводы

* Реализация стратегий и подача данных корректны; нулевая насыщенность обусловлена завышенными порогами и кэшированием.
* После подбора параметров свинговые метрики логичны и соответствуют структуре ценового ряда, что подтверждает валидность расчётов.

## 6. Рекомендации

1. **Перенастроить дефолтные параметры или сделать их адаптивными.** Рассмотреть уменьшение базовых амплитуд (например, `legs=5`, `deviation≈1 %` для ZigZag) или расчёт порогов от статистики зоны (диапазон цены/ATR) перед анализом, чтобы дефолт работал на узких зонах вроде `tv_xauusd_1h`.
2. **Включить конфигурацию стратегий в ключ кэша.** Добавить в `_generate_cache_key` сериализованную секцию `strategy_configs`, чтобы смена стратегии или параметров приводила к пересчёту результатов и не вводила исследователей в заблуждение.【F:bquant/analysis/zones/pipeline.py†L235-L277】
3. **Задокументировать процесс тюнинга и использовать скрипт в CI/research.** Описать, как отключать кэш, подбирать параметры и интерпретировать pivot-валидатор; добавить ссылку на `validate_swing_pivots.py` в разработческую документацию или make target.
4. **Опционально предоставить вспомогательные пресеты.** Можно добавить в конфиг несколько готовых профилей свинг-параметров (например, для «узких» и «широких» зон) и простую обёртку `.with_swing_preset('narrow_zones')`, чтобы пользователи не подбирали числа вручную.

Кардинального редизайна API не требуется: текущая архитектура уже поддерживает как внутренние стратегии, так и библиотечные индикаторы. Ключевые улучшения сосредоточены на реалистичных порогах, корректном кэшировании и документации процесса тюнинга.
